#!/bin/bash
#================================================
# The stor script is the central controller
# for user interaction with all Stor components
#================================================

usage()
{
cat << EOF
usage: $0 options

This script is used to run the Stor server and client. The -c or -s option must
be provided to start either the server or the client.

OPTIONS:
    -h      Show this message
    -c      Start the client
    -s      Start the server

SERVER OPTIONS:
    -p      The host address to be used by the Pastry server. This is required
            when using the -s option. This can be either the hostname or ip address.

CLIENT OPTIONS:
    -a      The action to take (PUT, GET, DELETE).
    -i      The file id to be used with a GET action. Required when using the GET action.
    -f      The filename used for the PUT action. Required when using the PUT action.
EOF
}

CMD=
HOST_ADDR=
FILENAME=
FILEID=
ACTION=
while getopts "p:f:a:i:sch" opt; do
  case $opt in
    h)
        usage
        exit 1
      ;;
    c)
        CMD=Client
      ;;
    s)
        CMD=Server
      ;;
    p)
        HOST_ADDR=$OPTARG
      ;; 
    f)
	FILENAME=$OPTARG
      ;;
    a)
        ACTION=$OPTARG
      ;;
    i)
        FILEID=$OPTARG
      ;;
    ?)
        usage
        exit 1
      ;;
  esac
done

if [[ -z $CMD ]]; then
     usage
     exit 1
fi

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
STOR="$( cd -P "$( dirname "$SOURCE" )"/.. && pwd )"

. $STOR/bin/env.sh

# Start server or client
if [ "$CMD" = "Client" ]; then
    echo "starting client!" >&2
    if [ "$ACTION" = "" ]; then
        echo "An action is required when running the Client."
        usage 
        exit 1
    fi

    if [ "$ACTION" = "PUT" ]; then  
        if [ "$FILENAME" = "" ]; then
            echo "A filename is required for PUT actions"
            usage
            exit 1
        fi

        $JAVA_HOME/bin/java -classpath $STOR/lib/stor-1.0.jar com.stor.client.Client PUT $FILENAME 

    elif [ "$ACTION" = "GET" ]; then
        if [ "$FILEID" = "" ]; then
            echo "A file Id is required when submitting a GET action"
            usage
            exit 1
        fi

        $JAVA_HOME/bin/java -classpath $STOR/lib/stor-1.0.jar com.stor.client.Client GET $FILEID
    else
        echo "$ACTION is not a recognized action"
        usage 
        exit 1
    fi	

else
    if [[ -z $HOST_ADDR ]]; then 
        echo "Missing required host address parameter"
        usage
        exit 1
    fi
    echo "starting server using host address: $HOST_ADDR!" >&2
    $JAVA_HOME/bin/java -classpath $STOR/lib/stor-1.0.jar com.stor.server.Server $HOST_ADDR &
fi
